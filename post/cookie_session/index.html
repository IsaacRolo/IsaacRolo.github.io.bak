<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Cookie_session - Rolo&#39;s Note</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rolo" /><meta name="description" content="为什么在2个服务器之间来回请求，同一个服务器的sessionId会找不到 第一次请求【服务器A】 Response Headers Set-Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C;path=/;HttpOnly 第二次请求【服务器B】 Response Headers Set-Cookie: JSESSIONID=1A08F620F659F860BF599FD37A51DCDD;path=/;HttpOnly Request Headers Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://isaacrolo.github.io/post/cookie_session/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Cookie_session" />
<meta property="og:description" content="为什么在2个服务器之间来回请求，同一个服务器的sessionId会找不到 第一次请求【服务器A】 Response Headers Set-Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C;path=/;HttpOnly 第二次请求【服务器B】 Response Headers Set-Cookie: JSESSIONID=1A08F620F659F860BF599FD37A51DCDD;path=/;HttpOnly Request Headers Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://isaacrolo.github.io/post/cookie_session/" />
<meta property="article:published_time" content="2019-05-20T19:30:33&#43;08:00"/>
<meta property="article:modified_time" content="2019-05-20T19:30:33&#43;08:00"/>

<meta itemprop="name" content="Cookie_session">
<meta itemprop="description" content="为什么在2个服务器之间来回请求，同一个服务器的sessionId会找不到 第一次请求【服务器A】 Response Headers Set-Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C;path=/;HttpOnly 第二次请求【服务器B】 Response Headers Set-Cookie: JSESSIONID=1A08F620F659F860BF599FD37A51DCDD;path=/;HttpOnly Request Headers Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C">


<meta itemprop="datePublished" content="2019-05-20T19:30:33&#43;08:00" />
<meta itemprop="dateModified" content="2019-05-20T19:30:33&#43;08:00" />
<meta itemprop="wordCount" content="5335">



<meta itemprop="keywords" content="web," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cookie_session"/>
<meta name="twitter:description" content="为什么在2个服务器之间来回请求，同一个服务器的sessionId会找不到 第一次请求【服务器A】 Response Headers Set-Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C;path=/;HttpOnly 第二次请求【服务器B】 Response Headers Set-Cookie: JSESSIONID=1A08F620F659F860BF599FD37A51DCDD;path=/;HttpOnly Request Headers Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">[√] [×]</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">[√] [×]</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Cookie_session</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-05-20 </span>
        <div class="post-category">
            <a href="/categories/web/"> web </a>
            </div>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#解决分布式系统session共享的问题-使用redis存储管理httpsession">解决分布式系统session共享的问题【使用Redis存储管理HttpSession】</a></li>
<li><a href="#问题原因">问题原因</a></li>
<li><a href="#解决方法">解决方法</a></li>
<li><a href="#集成步骤">集成步骤</a></li>
<li><a href="#解决ajax跨域session丢失的问题">解决AJAX跨域session丢失的问题</a></li>
<li><a href="#无状态的token认证-jwt-json-web-tokens">无状态的Token认证【JWT JSON Web Tokens】</a></li>
<li><a href="#remember-me">Remember Me</a></li>
<li><a href="#登录次数限制">登录次数限制</a></li>
<li><a href="#前后端分离分布式系统基于shiro的权限系统设计">前后端分离分布式系统基于Shiro的权限系统设计</a></li>
</ul></li>
<li><a href="#springsession源码分析-v-1-2-2">SpringSession源码分析【v.1.2.2】</a></li>
<li><a href="#servlet请求与响应的重写">Servlet请求与响应的重写</a>
<ul>
<li><a href="#重写请求-sessionrepositoryrequestwrapper">重写请求<code>SessionRepositoryRequestWrapper</code></a></li>
<li><a href="#重写响应-sessionrepositoryresponsewrapper">重写响应<code>SessionRepositoryResponseWrapper</code></a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<ul>
<li>为什么在2个服务器之间来回请求，同一个服务器的sessionId会找不到</li>
</ul>

<p><strong>第一次请求【服务器A】</strong></p>

<p><code>Response Headers</code></p>

<p>Set-Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C;path=/;HttpOnly</p>

<p><strong>第二次请求【服务器B】</strong></p>

<p><code>Response Headers</code></p>

<p>Set-Cookie: JSESSIONID=<strong>1A08F620F659F860BF599FD37A51DCDD</strong>;path=/;HttpOnly</p>

<p><code>Request Headers</code></p>

<p>Cookie: JSESSIONID=4A8E119166F37F26FF1D8ACF38F9742C</p>

<p><strong>第三次请求【服务器A】</strong></p>

<p><code>Response Headers</code></p>

<p>Set-Cookie: JSESSIONID=25F872DEA8145E2A6811ED212038478B;path=/;HttpOnly</p>

<p><code>Request Headers</code></p>

<p>Cookie: JSESSIONID=<strong>1A08F620F659F860BF599FD37A51DCDD</strong></p>

<p>服务端找不到cookie中的jsessionid，会创建新的session，并把sessionId存到客户端的cookie中</p>

<ul>
<li>jsessionid： tomcat生成的sessionid</li>
<li>session何时创建？ 在访问tomcat服务器HttpServletRequest的<code>getSession(true)</code>的时候创建【spring session在SessionRepositoryRequestWrapper.class 重写了getSession方法】</li>
<li>session存放在哪里？服务器端的内存中。session也可以通过特殊的方式做持久化管理（memcache，redis）。</li>
<li>session何时删除？超时；调用HttpSession.invalidate()；程序关闭；</li>
</ul>

<h4 id="解决分布式系统session共享的问题-使用redis存储管理httpsession">解决分布式系统session共享的问题【使用Redis存储管理HttpSession】</h4>

<hr />

<h4 id="问题原因">问题原因</h4>

<p>HttpSession是通过Servlet容器创建和管理的，像Tomcat/Jetty session都是保存在内存中的。而如果把web服务器搭建成分布式的集群，然后利用LVS或Nginx做负载均衡，那么来自同一用户的Http请求将有可能被分发到两个不同的web站点中去，从而导致session不一致的问题。</p>

<h4 id="解决方法">解决方法</h4>

<p>Spring Session提供了一套创建和管理Servlet HttpSession的方案，默认采用外置的Redis来存储Session数据，以此来解决Session共享的问题。</p>

<h4 id="集成步骤">集成步骤</h4>

<ul>
<li>pom文件添加依赖</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml">  <span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  
  <span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>org.springframework.session<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>spring-session-data-redis<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>application.yml配置redis连接</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span>spring<span class="p">:</span><span class="w">
</span><span class="w">    </span>redis<span class="p">:</span><span class="w">
</span><span class="w">      </span>host<span class="p">:</span><span class="w"> </span><span class="m">10.10</span>.<span class="m">10.236</span><span class="w">
</span><span class="w">      </span>password<span class="p">:</span><span class="w">
</span><span class="w">      </span>port<span class="p">:</span><span class="w"> </span><span class="m">6379</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>添加spring-session配置类【默认session最长有效时间1800s】</li>
</ul>

<p>实现原理：@EnableRedisHttpSession注解会创建一个Filter，过滤器中用Spring Session【Redis实现】来替换原先的默认HttpSession。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Configuration</span>
  <span class="nd">@EnableRedisHttpSession</span><span class="o">(</span><span class="n">maxInactiveIntervalInSeconds</span> <span class="o">=</span> <span class="n">3000</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionConfig</span> <span class="o">{</span>
  <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>操作HttpSession</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">      <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/set&#34;</span><span class="o">)</span>
      <span class="n">String</span> <span class="nf">set</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;testKey&#34;</span><span class="o">,</span> <span class="s">&#34;testValue&#34;</span><span class="o">);</span>
          <span class="k">return</span> <span class="s">&#34;设置session:testKey=testValue&#34;</span><span class="o">;</span>
      <span class="o">}</span>
  
      <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/query&#34;</span><span class="o">)</span>
      <span class="n">String</span> <span class="nf">query</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;testKey&#34;</span><span class="o">);</span>
          <span class="k">return</span> <span class="s">&#34;查询Session：\&#34;testKey\&#34;=&#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="解决ajax跨域session丢失的问题">解决AJAX跨域session丢失的问题</h4>

<hr />

<ul>
<li>ajax请求时将withCredentials设为true</li>
</ul>

<p>表示浏览器发请求时，发送Cookie和HTTP认证信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;http://localhost:8032/&#34;</span><span class="p">,</span>
      <span class="nx">xhrFields</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">withCredentials</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">},</span>
      <span class="nx">success</span> <span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{}</span>
  <span class="p">}</span><span class="err">）</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>zuul网关设置过滤器【继承ZuulFilter】</li>
</ul>

<p><code>Access-Control-Allow-Credentials</code>表示是否允许发送Cookie</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="n">response</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">&#34;Access-Control-Allow-Origin&#34;</span><span class="o">,</span> <span class="s">&#34;http://localhost:8877&#34;</span><span class="o">);</span>
  <span class="n">response</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">&#34;Access-Control-Allow-Credentials&#34;</span><span class="o">,</span> <span class="s">&#34;true&#34;</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>PS：如果要发送Cookie，<code>Access-Control-Allow-Origin</code>不能设为 *，必须指定明确的、与请求网页一致的域名</p>

<h4 id="无状态的token认证-jwt-json-web-tokens">无状态的Token认证【JWT JSON Web Tokens】</h4>

<hr />

<ul>
<li><p>JWT和session持久化 两种方案的区别</p>

<ul>
<li>JWT：服务器不保存 session 数据，所有数据都保存在客户端，每次请求都发回服务器。</li>
</ul>

<p>最大的缺点在于一旦 JWT 签发了，在到期之前就会始终有效，无法在使用过程中废止某个 token。</p>

<p>JWT 本身包含了认证信息，为了减少盗用，JWT 的有效期应该设置得比较短。同时使用 HTTPS 协议传输</p>

<ul>
<li>session持久化：各种服务收到请求后，都向持久层请求数据。</li>
</ul>

<p>这种方案的优点是架构清晰，缺点是持久层的压力较大。</p></li>

<li><p>JWT使用流程</p>

<ul>
<li>用户使用用户名密码来请求服务器</li>
<li>服务器进行验证用户的信息</li>
<li>服务器通过验证发送给用户一个token</li>
<li>客户端存储token，并在每次请求时附送上这个token值</li>
<li>服务端验证token值，并返回数据</li>
</ul></li>

<li><p>JWT的原理</p></li>
</ul>

<p>服务器认证以后，生成一个 JSON 对象，发回给用户。</p>

<p>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。</p>

<p>为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名。</p>

<p>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</p>

<ul>
<li>jwt结构</li>
</ul>

<p>它是一个很长的字符串，中间用点（<code>.</code>）分隔成三个部分。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</pre></td></tr></table>
</div>
</div>
<ul>
<li><p>Header</p>

<p>Header 部分是一个 JSON 对象，描述 JWT 的元数据，Base64URL转换成字符串</p></li>

<li><p>Payload</p>

<p>Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据，Base64URL转换成字符串。</p>

<p>JWT 规定了7个官方字段(建议但不强制使用，可定义私有字段)</p>

<blockquote>
<ul>
<li>iss (issuer)：签发人</li>
<li>exp (expiration time)：过期时间</li>
<li>sub (subject)：主题</li>
<li>aud (audience)：受众</li>
<li>nbf (Not Before)：生效时间</li>
<li>iat (Issued At)：签发时间</li>
<li>jti (JWT ID)：编号</li>
</ul>
</blockquote>

<p>此部分没有加密，不建议存放敏感信息【生成Token之后再次加密，就可放入敏感信息】</p></li>

<li><p>Signature</p>

<p>Signature 部分是对前两部分的签名，防止数据篡改。</p>

<p>计算签名的公式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">HMACSHA256(
  base64UrlEncode(header) + &#34;.&#34; +
  base64UrlEncode(payload),
  secret)</pre></td></tr></table>
</div>
</div></li>

<li><p>使用jwt的几种方式</p></li>
</ul>

<p>客户端收到服务器返回的 JWT，储存在本地</p>

<p>此后，客户端每次与服务器通信，都要带上JWT</p>

<ul>
<li>把JWT放在 Cookie 里面自动发送，但是不能跨域</li>
<li>把JWT放在 HTTP 请求的头信息<code>Authorization</code>字段里面</li>
<li>跨域的时候，JWT 放在 POST 请求的数据体里面</li>
</ul>

<h4 id="remember-me">Remember Me</h4>

<hr />

<p>系统默认位登录状态，跨session记录用户身份</p>

<h4 id="登录次数限制">登录次数限制</h4>

<hr />

<p>TODO:其他人登录时锁定登录人session的账号</p>

<h4 id="前后端分离分布式系统基于shiro的权限系统设计">前后端分离分布式系统基于Shiro的权限系统设计</h4>

<hr />

<p>问题</p>

<ul>
<li>前后端分离的系统，页面路由跳转由前端控制，就不能使用Shiro拦截请求之后来控制页面的跳转了</li>
</ul>

<p>拦截的请求跳转到后台接口，后台接口返回msg，前端通过返回的msg来控制路由</p>

<ul>
<li><p>前后端分离的系统的<strong>权限</strong>问题</p></li>

<li><p>分布式系统需要在每个服务都配置Shiro拦截吗？</p></li>
</ul>

<p>都需要配置拦截，不然用户不登录就可以直接访问其他页面</p>

<ul>
<li><p>分布式系统需要考虑session共享的问题</p></li>

<li><p>系统里集成了另一个系统，需要实现单点登录，</p></li>
</ul>

<p>清除缓存后报错</p>

<p>zuul  SavedRequest Dispatcherservlet</p>

<p>莫名其妙的报java.lang.ClassNotFoundException: com.calabar.caac.web.filter.Principal错</p>

<p>[spring-data-redis-1.7.6.RELEASE.jar 说明和redis 存的session 里由shiro的类有关</p>

<p>没有这个类就没法反序列化，导致浏览器的所有请求都会报500错</p>

<blockquote>
<p>session在什么时候进行反序列化？</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception
org.springframework.data.redis.serializer.SerializationException: Cannot deserialize; nested exception is org.springframework.core.serializer.support.SerializationFailedException: Failed to deserialize payload. Is the byte array a result of corresponding serialization for DefaultDeserializer?; nested exception is org.springframework.core.NestedIOException: Failed to deserialize object type; nested exception is java.lang.ClassNotFoundException: org.apache.shiro.web.util.SavedRequest</pre></td></tr></table>
</div>
</div>
<p>Q 重定向次数过多</p>

<p>A index重定向index，index再次被拦截继续重定向 形成循环</p>

<p>Q zuul不做页面装发 只做接口转发</p>

<p>登录页面不被拦截——登录html页面请求其他静态资源会被拦截</p>

<p>Q 请求经过zuul转发之后获取不到session</p>

<p><a href="https://segmentfault.com/a/1190000014204992">https://segmentfault.com/a/1190000014204992</a></p>

<p>Q 前后端分离系统获取session中的数据需要发ajax请求到后端接口获取（比如获取已登录的用户名）</p>

<p>A 使用<strong>sessionStorage</strong>存放用户名</p>

<p>Q分布式部署导致sessionid不一致，而无法登录的问题</p>

<p>A 点击登录 &ndash; 过滤器 getSession 【登录接口放行】&ndash; 登录接口 getSession &ndash;登录成功</p>

<p>​   访问其他页面 &ndash; 过滤器 getSession</p>

<ul>
<li>cookie过滤器【zuul】，手动将sessionid写入请求头的cookie属性中</li>
<li>登录过滤器【zuul】，判断session中是否有用户名字段，若有则登录成功</li>
<li>登录接口【用户服务】，将用户信息存入session</li>
</ul>

<p>68服务器</p>

<ul>
<li>ereka1</li>
<li>es</li>
<li>zuul                     1</li>
<li>jz</li>
<li>kewa-safety</li>
<li>yk</li>
</ul>

<p>56服务器</p>

<ul>
<li>ereka2</li>
<li>kewa-user        3</li>
<li>kr</li>
<li>safety</li>
<li>user</li>
<li>web                 2</li>
</ul>

<h3 id="springsession源码分析-v-1-2-2">SpringSession源码分析【v.1.2.2】</h3>

<hr />

<p>开发的时候遇到 一个奇怪的问题，在多台服务器上分布式部署微服务时，使用Spring Session将session存放在redis中实现共享，请求通过zuul转发后会出现sessionid不断改变的现象。抓包分析无果后，打算分析下Spring Session的源码，看下新的sessionId是何时被设置到cookie中的【response header - set-cookie】</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionRepositoryFilter</span><span class="o">&lt;</span><span class="n">S</span> <span class="kd">extends</span> <span class="n">ExpiringSession</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="o">......</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SessionRepositoryRequestWrapper</span> <span class="kd">extends</span> <span class="n">HttpServletRequestWrapper</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">HttpSessionWrapper</span> <span class="nf">getSession</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">create</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">HttpSessionWrapper</span> <span class="n">currentSession</span> <span class="o">=</span> <span class="n">getCurrentSession</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">currentSession</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">currentSession</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">//请求中获取sessionId
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">requestedSessionId</span> <span class="o">=</span> <span class="n">getRequestedSessionId</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">requestedSessionId</span> <span class="o">!=</span> <span class="kc">null</span>
                    <span class="o">&amp;&amp;</span> <span class="n">getAttribute</span><span class="o">(</span><span class="n">INVALID_SESSION_ID_ATTR</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//存储中获取session
</span><span class="c1"></span>                <span class="n">S</span> <span class="n">session</span> <span class="o">=</span> <span class="n">getSession</span><span class="o">(</span><span class="n">requestedSessionId</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">session</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">requestedSessionIdValid</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">currentSession</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpSessionWrapper</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">getServletContext</span><span class="o">());</span>
                    <span class="n">currentSession</span><span class="o">.</span><span class="na">setNew</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                    <span class="n">setCurrentSession</span><span class="o">(</span><span class="n">currentSession</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">currentSession</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// This is an invalid session id. No need to ask again if
</span><span class="c1"></span>                    <span class="c1">// request.getSession is invoked for the duration of this request
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">SESSION_LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">SESSION_LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
                                <span class="s">&#34;No session found by id: Caching result for getSession(false) for this HttpServletRequest.&#34;</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">setAttribute</span><span class="o">(</span><span class="n">INVALID_SESSION_ID_ATTR</span><span class="o">,</span> <span class="s">&#34;true&#34;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">//是否创建新的session【首次登录或session失效】
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">create</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">SESSION_LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">SESSION_LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
                        <span class="s">&#34;A new session was created. To help you troubleshoot where the session was created we provided a StackTrace (this is not an error). You can prevent this from appearing by disabling DEBUG logging for &#34;</span>
                                <span class="o">+</span> <span class="n">SESSION_LOGGER_NAME</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                                <span class="s">&#34;For debugging purposes only (not an error)&#34;</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">S</span> <span class="n">session</span> <span class="o">=</span> <span class="n">SessionRepositoryFilter</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sessionRepository</span><span class="o">.</span><span class="na">createSession</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">setLastAccessedTime</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="n">currentSession</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpSessionWrapper</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">getServletContext</span><span class="o">());</span>
            <span class="n">setCurrentSession</span><span class="o">(</span><span class="n">currentSession</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">currentSession</span><span class="o">;</span>
        <span class="o">}</span>    </code></pre></td></tr></table>
</div>
</div>
<ul>
<li>java与web容器交互的标准接口：<code>HttpServletRequset</code>和<code>HttpServletResponse</code></li>
<li>接口是在不同的web容器内部实现的</li>
<li>SpringSession中需要继承<code>HttpServletRequestWrapper</code>，并重写容器实现的<code>getSession()</code>方法，来实现分布式session</li>
</ul>

<p>SpringSession之<code>getSession</code>方法的内部逻辑</p>

<ol>
<li>从当前请求线程中获取 session，如果有直接返回</li>
<li>sessionid有效，从请求中获取 sessionid，并根据sessionid从存储中获取session对象，最后将当前的 session 设置到当前请求线程中</li>
<li>如果在当前请求中和存储中都没有获取到<code>session</code>，创建新的session</li>
</ol>

<h3 id="servlet请求与响应的重写">Servlet请求与响应的重写</h3>

<h4 id="重写请求-sessionrepositoryrequestwrapper">重写请求<code>SessionRepositoryRequestWrapper</code></h4>

<blockquote>
<p>getCurrentSession( )</p>

<p>从当前请求线程中获取 session；避免在同一个请求中多次从存储中获取session</p>

<p>getRequestedSessionId( )</p>

<p>从请求中获取sessionId有2种方式</p>

<ul>
<li>CookieHttpSessionStrategy</li>
</ul>

<p>从<code>request</code>中取出所有<code>cookie</code>，遍历找<code>sessionId</code>的<code>cookie</code>，如果是以<code>SESSION</code>开头，则表示是 <code>SessionId</code></p>

<ul>
<li>HeaderHttpSessionStrategy</li>
</ul>

<p>根据 <code>headerName</code> 从 <code>header</code> 中取值</p>
</blockquote>

<h4 id="重写响应-sessionrepositoryresponsewrapper">重写响应<code>SessionRepositoryResponseWrapper</code></h4>

<blockquote>
<p>commitSession( ) 【处理<code>session</code>提交，将<code>session</code>保存到存储容器中】</p>

<p>源码中的注释清晰的说明了此方法的作用：<strong>Uses the HttpSessionStrategy to write the session id to the response and persist the Session.</strong></p>

<p>从当前请求中找session</p>

<p>如果找不到，则在回写<code>cookie</code>时会将当前<code>session</code>对应的<code>cookie</code>值设置为空</p>

<p>如果找得到，则清空当前请求中的<code>session</code>信息，然后将<code>session</code>保存到存储容器中，并且将<code>sessionId</code>回写到<code>cookie</code>中。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="cm">/**
</span><span class="cm">         * Uses the HttpSessionStrategy to write the session id to the response and
</span><span class="cm">         * persist the Session.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">commitSession</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">HttpSessionWrapper</span> <span class="n">wrappedSession</span> <span class="o">=</span> <span class="n">getCurrentSession</span><span class="o">();</span>
            <span class="c1">//当前请求中没有session
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">wrappedSession</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">isInvalidateClientSession</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">SessionRepositoryFilter</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">httpSessionStrategy</span>
                            <span class="o">.</span><span class="na">onInvalidateSession</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">response</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">//当前请求中有请求
</span><span class="c1"></span>            <span class="k">else</span> <span class="o">{</span>
                <span class="n">S</span> <span class="n">session</span> <span class="o">=</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
                <span class="n">SessionRepositoryFilter</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sessionRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">isRequestedSessionIdValid</span><span class="o">()</span>
                        <span class="o">||</span> <span class="o">!</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">getRequestedSessionId</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">SessionRepositoryFilter</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">httpSessionStrategy</span><span class="o">.</span><span class="na">onNewSession</span><span class="o">(</span><span class="n">session</span><span class="o">,</span>
                            <span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">response</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>分析后得知 <code>response</code> 中回写<code>cookie</code>的<code>sessionId</code>【set-cookie】的逻辑是写在<code>commitSession()</code>方法中的</p>

<p>进一步分析，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(!</span><span class="n">isRequestedSessionIdValid</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">getRequestedSessionId</span><span class="o">())){</span>
    <span class="o">......</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>发现set-cookie操作是在请求中的sessionId失效 或 当前请求中session的sessionId 和请求中cookie的sessionId不相等时才会执行。</p>

<p>至此问题极大可能问题是出在<strong>session的有效期</strong>上。</p>

<p>继续看判断session是否有效的方法<code>isRequestedSessionIdValid()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRequestedSessionIdValid</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">requestedSessionIdValid</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">sessionId</span> <span class="o">=</span> <span class="n">getRequestedSessionId</span><span class="o">();</span>
                <span class="n">S</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionId</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">getSession</span><span class="o">(</span><span class="n">sessionId</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">isRequestedSessionIdValid</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">requestedSessionIdValid</span><span class="o">;</span>
        <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>sessionId</code>若不为空，则通过<code>getSession(String sessionId)</code>方法获取session</p>

<p>接着看<code>getSession(String sessionId)</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">        <span class="kd">private</span> <span class="n">S</span> <span class="nf">getSession</span><span class="o">(</span><span class="n">String</span> <span class="n">sessionId</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//从存储中找session
</span><span class="c1"></span>            <span class="n">S</span> <span class="n">session</span> <span class="o">=</span> <span class="n">SessionRepositoryFilter</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sessionRepository</span>
                    <span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="n">sessionId</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">session</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">session</span><span class="o">.</span><span class="na">setLastAccessedTime</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">session</span><span class="o">;</span>
        <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在redis中找session，进入<code>RedisOperationsSessionRepository.class</code>中的<code>getSession(String id, boolean allowExpired)</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="n">RedisSession</span> <span class="nf">getSession</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowExpired</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">getSessionBoundHashOperations</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">entries</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entries</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">MapSession</span> <span class="n">loaded</span> <span class="o">=</span> <span class="n">loadSession</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">entries</span><span class="o">);</span>
        <span class="c1">//在redis存储中获取session需要判断session是否有效
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">allowExpired</span> <span class="o">&amp;&amp;</span> <span class="n">loaded</span><span class="o">.</span><span class="na">isExpired</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">RedisSession</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RedisSession</span><span class="o">(</span><span class="n">loaded</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">originalLastAccessTime</span> <span class="o">=</span> <span class="n">loaded</span><span class="o">.</span><span class="na">getLastAccessedTime</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>最后来看判断此session有没有过期的方法，由以下3个参数来决定</p>

<ul>
<li>maxInactiveInterval 最大闲置时间</li>
<li>lastAccessedTime 上一次访问时间</li>
<li>now 系统当前时间</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kt">boolean</span> <span class="nf">isExpired</span><span class="o">(</span><span class="kt">long</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">maxInactiveInterval</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">now</span> <span class="o">-</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
                <span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">maxInactiveInterval</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">lastAccessedTime</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>将当前系统时间减去过期时间，若结果大于等于上次访问时间，则表示此session过期。</p>

<p>检查了下各服务器的时间，果然时间不同步。</p>

<p>Finally，问题解决，原来是分布式部署的服务器之间时间不一致，导致session<strong>失效</strong></p>

<h4 id="参考资料">参考资料</h4>

<hr />

<p><a href="http://www.ityouknow.com/it/2019/05/11/cookie-session.html">你真的了解 Cookie 和 Session 吗</a></p>

<p><a href="https://blog.csdn.net/hansexploration/article/details/80314948">jsonp原理详解</a></p>

<p><a href="https://www.jianshu.com/p/b5a96142fdd9">session共享问题</a></p>

<p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解</a></p>

<p><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">JSON Web Token 入门教程</a></p>

<p><a href="https://www.cnblogs.com/chenpi/p/5434537.html">Tomcat中的Session小结</a></p>

<p><a href="https://my.oschina.net/OutOfMemory/blog/1837937">Spring-Session基于Redis管理Session</a></p>

<p><a href="https://juejin.im/post/5bf8f179e51d450c487d0df2">SpringSession源码分析1 请求-响应</a></p>

<p><a href="https://juejin.im/post/5c153b61f265da61117a32aa">SpringSession源码分析2 redis</a></p>

<p><a href="https://blog.csdn.net/gmowcey/article/details/78507994">时间不同步导致Spring session失效</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rolo</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2019-05-20
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/web/">web</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/elasticsearch/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Elasticsearch</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/jsoup/">
            <span class="next-text nav-default">Java爬虫—Jsoup</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  
  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="elrolo@outlook.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/IsaacRolo" class="iconfont icon-github" title="github"></a>
  <a href="https://isaacrolo.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rolo</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
