<!DOCTYPE html>
<html lang="zn-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="author" content="Rolo">
		<meta name="description" content="Rolo&#39;s Blog">
		<meta name="generator" content="Hugo 0.54.0" />
		<title>整合HystrixDashboard和Turbine &middot; Rolo&#39;s Blog</title>
		<link rel="shortcut icon" href="https://isaacrolo.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://isaacrolo.github.io/css/style.css">
		<link rel="stylesheet" href="https://isaacrolo.github.io/css/highlight.css">

		
		<link rel="stylesheet" href="https://isaacrolo.github.io/css/font-awesome.min.css">
		

		
		<link href="https://isaacrolo.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Rolo&#39;s Blog" />
		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://isaacrolo.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://isaacrolo.github.io/posts'>Archive</a>
	<a href='https://isaacrolo.github.io/tags'>Tags</a>
	<a href='https://isaacrolo.github.io/about'>About</a>

	

	
	<a class="cta" href="https://isaacrolo.github.io/index.xml">Subscribe</a>
	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        整合HystrixDashboard和Turbine
                    </h1>
                    <h2 class="headline">
                    Mar 19, 2019 11:32
                    · 912 words
                    · 2 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://isaacrolo.github.io/tags/spring-cloud">Spring Cloud</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                  
                    <div id="toc">
                      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#hystrix-dashboard服务">Hystrix Dashboard服务</a></li>
<li><a href="#springboot-consumer服务">Springboot-Consumer服务</a></li>
<li><a href="#为什么要配置hystrixmetricsstreamservlet">为什么要配置HystrixMetricsStreamServlet</a></li>
<li><a href="#turbine服务">Turbine服务</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
                    </div>
                  
                
                <section id="post-body">
                    

<p><strong>前提</strong>：springboot 1.5.19.RELEASE    springcloud Edgware.SR5</p>

<p><strong>场景</strong>：服务调用方使用Feign+Hystrix实现微服务之间的通信；新建一个Hystrix Dashboard微服务来实现Hystrix的实时监控</p>

<h4 id="hystrix-dashboard服务">Hystrix Dashboard服务</h4>

<p>实时监控Hystrix ，可以直观的查看各Hystrix Command的请求响应时间，请求成功率等数据</p>

<ol>
<li>添加依赖</li>
</ol>

<pre><code class="language-xml">        &lt;dependency&gt;
             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
               &lt;artifactId&gt;spring-cloud-starter-hystrix-dashboard&lt;/artifactId&gt;
        &lt;/dependency&gt;
   
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
   
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>

<ol>
<li>启动类添加注解</li>
</ol>

<pre><code class="language-java">   @EnableHystrixDashboard
   @EnableCircuitBreaker
</code></pre>

<h4 id="springboot-consumer服务">Springboot-Consumer服务</h4>

<ol>
<li>添加依赖；因为Feign里内置Hystrix断路器，所以无需引入spring-cloud-starter-hystrix依赖，无需添加@EnableCircuitBreaker注解</li>
</ol>

<pre><code class="language-xml">           &lt;dependency&gt;
              &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
              &lt;artifactId&gt;spring-cloud-starter-hystrix-dashboard&lt;/artifactId&gt;
           &lt;/dependency&gt;
   
           &lt;dependency&gt;
              &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
              &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
           &lt;/dependency&gt;
</code></pre>

<ol>
<li>配置映射到&rdquo;/hystrix.stream&rdquo;的servlet (HystrixMetricsStreamServlet)</li>
</ol>

<pre><code class="language-java">   @Configuration
   public class HystrixStreamConfig {
       @Bean
       public ServletRegistrationBean getServlet() {
           HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
           ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet);
           registrationBean.setLoadOnStartup(1);
           registrationBean.addUrlMappings(&quot;/hystrix.stream&quot;);
           registrationBean.setName(&quot;HystrixMetricsStreamServlet&quot;);
           return registrationBean;
       }
   }
</code></pre>

<ol>
<li>启动工程后访问 <a href="http://localhost:">http://localhost:</a> HystrixDashboard服务的port/hystrix</li>
</ol>

<p>查看单个应用使用url：<a href="http://localhost:">http://localhost:</a> consumer服务的port/hystrix.stream</p>

<p>如果遇到：Unable to connect to Command Metric Stream.错误，请检查以上步骤；若还是出现此错误，请考虑<strong>Hystrix Dashboard访问消费者服务的hystrix.stream时被拦截的可能性</strong>（shiro拦截了Hystrix Dashboard的请求）</p>

<h4 id="为什么要配置hystrixmetricsstreamservlet">为什么要配置HystrixMetricsStreamServlet</h4>

<p><a href="http://localhost:">http://localhost:</a> consumer服务的port/hystrix.stream 不能正确访问到，需要手动配置url的映射</p>

<p>源码见：HystrixStreamEndpoint.java;HystrixMetricsStreamServlet.java</p>

<h4 id="turbine服务">Turbine服务</h4>

<p>把多个hystrix.stream的内容聚合为一个数据源供HystrixDashboard展示</p>

<ol>
<li>添加依赖</li>
</ol>

<pre><code class="language-xml">   &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-turbine&lt;/artifactId&gt;
   &lt;/dependency&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-netflix-turbine&lt;/artifactId&gt;
   &lt;/dependency&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
   &lt;/dependency&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-hystrix-dashboard&lt;/artifactId&gt;
   &lt;/dependency&gt;
</code></pre>

<ol>
<li>启动类添加注解</li>
</ol>

<pre><code class="language-java">   @EnableHystrixDashboard
   @EnableTurbine
</code></pre>

<ol>
<li>配置文件</li>
</ol>

<pre><code class="language-yaml">   server:
     port: 8031
   spring:
     application:
       name: microservice-turbine
   turbine:
     appConfig: microservice-web
     aggregator:
       clusterConfig: default
     clusterNameExpression: new String(&quot;default&quot;)
</code></pre>

<ol>
<li>访问<a href="http://localhost:8031/hystrix填入http://localhost:8031/turbine.stream">http://localhost:8031/hystrix填入http://localhost:8031/turbine.stream</a></li>
</ol>

<p>参考资料</p>

<p><a href="http://www.ityouknow.com/springcloud/2017/05/18/hystrix-dashboard-turbine.html">http://www.ityouknow.com/springcloud/2017/05/18/hystrix-dashboard-turbine.html</a></p>

<p><a href="https://www.cnblogs.com/mark7/p/8920288.html">https://www.cnblogs.com/mark7/p/8920288.html</a></p>

<p><a href="https://www.cnblogs.com/chry/p/7286601.html">https://www.cnblogs.com/chry/p/7286601.html</a></p>

<p><a href="https://blog.csdn.net/ddxd0406/article/details/79643059">https://blog.csdn.net/ddxd0406/article/details/79643059</a></p>

                </section>
            </article>

            
                <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fisaacrolo.github.io%2fposts%2fhystrixdashboard%2f - %e6%95%b4%e5%90%88HystrixDashboard%e5%92%8cTurbine by @your_twitter_id"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

            

            

            

            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://github.com/IsaacRolo">
        <i class="fa fa-github-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2019 <i class="fa fa-heart" aria-hidden="true"></i> Rolo
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="https://isaacrolo.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://isaacrolo.github.io/js/main.js"></script>
<script src="https://isaacrolo.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







    </body>
</html>
